<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retro Quimi-Consola</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --retro-green: #00FF41; --dark-bg: #0d0d0d; --glow-color: rgba(0, 255, 65, 0.5); --red-error: #e74c3c; --yellow-warn: #f39c12; }
        body { background-color: var(--dark-bg); color: var(--retro-green); font-family: 'Press Start 2P', cursive; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; text-shadow: 0 0 5px var(--glow-color); text-align: center; }
        .game-container { width: 95%; max-width: 800px; background: #000; border: 2px solid var(--retro-green); border-radius: 15px; padding: 25px; box-shadow: 0 0 20px var(--glow-color), inset 0 0 15px rgba(0, 255, 65, 0.2); position: relative; overflow: hidden; }
        .game-container::after { content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: repeating-linear-gradient(0deg, rgba(0, 0, 0, 0.3) 0px, rgba(0, 0, 0, 0.3) 1px, transparent 1px, transparent 3px); pointer-events: none; }
        .screen { display: none; }
        .screen.active { display: block; }
        #splash-screen { animation: text-flicker 0.1s infinite alternate; }
        #splash-screen .rules-container, #admin-report-view { text-align: left; font-size: 0.8em; line-height: 1.8; }
        #splash-screen .hidden-line { visibility: hidden; }
        .blinking-cursor::after { content: '_'; animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { visibility: hidden; } }
        h1, h2, h3 { line-height: 1.5; }
        h1 { font-size: 1.5em; margin-bottom: 20px; }
        h2 { font-size: 1.1em; }
        p { font-size: 0.8em; line-height: 1.5; margin-bottom: 20px; }
        .btn { background: transparent; border: 2px solid var(--retro-green); color: var(--retro-green); padding: 15px; font-family: inherit; font-size: 0.8em; cursor: pointer; transition: background-color 0.2s, color 0.2s; margin-top: 10px; }
        .btn:hover:not([disabled]) { background-color: var(--retro-green); color: var(--dark-bg); text-shadow: none; }
        .btn.danger { border-color: var(--red-error); color: var(--red-error); }
        .btn.danger:hover { background-color: var(--red-error); color: var(--dark-bg); }
        .btn-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 600px) { .btn-grid { grid-template-columns: repeat(2, 1fr); } }
        .btn.correct { background-color: #27ae60; color: #fff; border-color: #27ae60; }
        .btn.incorrect { background-color: var(--red-error); color: #fff; border-color: #c0392b; }
        .btn[disabled] { cursor: not-allowed; opacity: 0.5; }
        .hidden { display: none; }
        .input-field { background: transparent; border: 2px solid var(--retro-green); color: var(--retro-green); font-family: inherit; padding: 10px; width: 60%; text-align: center; margin: 10px; font-size: 1em; }
        .input-field:focus { outline: none; box-shadow: 0 0 10px var(--glow-color); }
        .admin-section { margin-top: 25px; border-top: 1px solid var(--retro-green); padding-top: 15px; }
        .admin-section h3 { text-align: center; }
        #feedback-box { margin-top: 20px; padding: 15px; border: 1px dashed var(--yellow-warn); color: var(--yellow-warn); text-align: left; }
        #feedback-box strong { display: block; margin-bottom: 5px; }
        #achievements-section { text-align: center; }
        .achievement { display: inline-block; margin: 5px; padding: 8px 12px; border: 1px solid var(--yellow-warn); color: var(--yellow-warn); font-size: 0.7em; }
        .achievement .icon { margin-right: 5px; }
        #chart-container, .admin-chart-container { position: relative; width: 90%; max-width: 500px; margin: 20px auto; background-color: rgba(0, 255, 65, 0.05); padding: 10px; border: 1px solid var(--retro-green); }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Contenedores de Pantalla -->
        <div id="splash-screen" class="screen active"></div>
        <div id="name-screen" class="screen"></div>
        <div id="setup-screen" class="screen"></div>
        <div id="challenge-offer-screen" class="screen"></div>
        <div id="game-screen" class="screen"></div>
        <div id="end-screen" class="screen"></div>
        <div id="admin-login-screen" class="screen"></div>
        <div id="admin-dashboard-screen" class="screen"></div>
        <div id="admin-report-screen" class="screen"></div>
    </div>
    
    <audio id="sound-correct" src="https://www.myinstants.com/media/sounds/correct-sound-effect.mp3" preload="auto"></audio>
    <audio id="sound-incorrect" src="https://www.myinstants.com/media/sounds/wrong-sound-effect.mp3" preload="auto"></audio>

    <script>
    function injectHTML() {
        document.getElementById('splash-screen').innerHTML = `<h1 id="splash-title" class="hidden-line">Dise√±ado por Luis Oviedo</h1><div class="rules-container"><p id="line-1" class="hidden-line">> INICIANDO PROTOCOLO "QUIMI-CONSOLA"</p><p id="line-2" class="hidden-line">> TRANSMISI√ìN ENTRANTE...</p><p id="line-3" class="hidden-line">Saludos, Agente. Tu misi√≥n: demostrar tu maestr√≠a sobre los elementos.</p><p id="line-4" class="hidden-line">> REGLAS DE LA MISI√ìN:</p><p id="line-5" class="hidden-line" style="padding-left: 20px;">1. INGRESO: Registra tus iniciales.</p><p id="line-6" class="hidden-line" style="padding-left: 20px;">2. EL RETO: Supera 10 interrogantes. Obt√©n una nota de 1 a 10.</p><p id="line-7" class="hidden-line" style="padding-left: 20px;">3. EXPERIENCIA: Gana XP para el ranking seg√∫n tu avance y eficiencia.</p><p id="line-8" class="hidden-line" style="padding-left: 20px;">4. L√çMITE DE ERRORES: Tienes un margen de 3 fallos.</p><p id="line-9" class="hidden-line">> PREPAR√ÅNDOTE PARA LA INFILTRACI√ìN...</p><p id="loading-text" class="hidden-line">> CARGANDO BANCO DE DATOS<span class="blinking-cursor"></span></p></div><button id="continue-btn" class="btn hidden">> CONTINUAR AL RETO <</button>`;
        document.getElementById('name-screen').innerHTML = `<h1>> REGISTRO DE JUGADOR</h1><p>INGRESA TUS INICIALES (MAX 5 LETRAS):</p><input type="text" id="name-input" class="input-field" maxlength="5" placeholder="PROFE"><button id="submit-name-btn" class="btn">> CONTINUAR</button>`;
        document.getElementById('setup-screen').innerHTML = `<h1 id="setup-title"></h1><p>SELECCIONE NIVEL EDUCATIVO:</p><div class="btn-grid" id="setup-grade-buttons"></div>`;
        document.getElementById('game-screen').innerHTML = `<div id="status-bar" style="display: flex; justify-content: space-around; margin-bottom: 20px; font-size: 0.9em;"><div id="question-counter"></div><div id="errors-status"></div></div><h2 id="question-text"></h2><div id="chart-container" class="hidden"><canvas id="question-chart"></canvas></div><div id="answer-buttons" class="btn-grid"></div><div id="feedback-box" class="hidden"></div><button id="next-btn" class="btn hidden">> SIGUIENTE</button>`;
        document.getElementById('challenge-offer-screen').innerHTML = `<h1>> MISI√ìN PERFECTA</h1><p>Agente, has demostrado una maestr√≠a impecable. Se ha desbloqueado un nuevo nivel de desaf√≠o.</p><p>Las reglas cambian: las preguntas ser√°n de m√°xima dificultad y el PRIMER ERROR terminar√° la misi√≥n. A cambio, la recompensa en XP ser√° legendaria.</p><p>¬øAceptas el desaf√≠o?</p><div class="btn-grid"><button id="accept-challenge-btn" class="btn">> ACEPTAR DESAF√çO <</button><button id="decline-challenge-btn" class="btn danger">> VER PUNTAJE <</button></div>`;
        document.getElementById('end-screen').innerHTML = `<h2 id="end-title"></h2><div id="end-message"></div><div class="score-details" style="text-align: left; margin: 20px auto; max-width: 450px; background-color: rgba(0, 255, 65, 0.1); padding: 15px; border: 1px solid var(--retro-green); font-size: 0.8em;"><p id="final-grade-text"></p><p id="xp-earned-text"></p></div><div id="achievements-section" class="admin-section"><h3>> LOGROS DESBLOQUEADOS <</h3><div id="achievements-list"></div></div><div id="leaderboard" class="leaderboard admin-section"><h3 style="text-align: center; margin-bottom: 10px;">> MEJORES PUNTAJES (XP) <</h3><table id="leaderboard-table" style="width: 100%; border-collapse: collapse;"></table></div><button id="restart-btn" class="btn">> JUGAR DE NUEVO</button>`;
        document.getElementById('admin-login-screen').innerHTML = `<h1>> ACCESO DE PROFESOR</h1><p>INGRESE CONTRASE√ëA:</p><input type="password" id="admin-password" class="input-field"><button id="admin-login-btn" class="btn">> INGRESAR</button><button id="admin-back-btn" class="btn danger" style="margin-top: 20px;">> VOLVER</button>`;
        document.getElementById('admin-dashboard-screen').innerHTML = `<h1>> PANEL DE AN√ÅLISIS</h1><p>Seleccione un grado para ver el informe pedag√≥gico.</p><div id="admin-grade-selection" class="btn-grid"></div><div class="admin-section"><button id="download-analytics-btn" class="btn">> Descargar Datos Crudos</button><button id="reset-all-analytics-btn" class="btn danger">> Resetear TODOS los Datos</button></div><button id="admin-logout-btn" class="btn" style="margin-top: 20px;">> SALIR</button>`;
        document.getElementById('admin-report-screen').innerHTML = `<h1 id="admin-report-title"></h1><div id="admin-report-view"></div><button id="back-to-dashboard-btn" class="btn" style="margin-top: 20px;">< Volver al Panel</button>`;
    }
    injectHTML();

    document.addEventListener('DOMContentLoaded', () => {
        const ADMIN_PASSWORD = "QUIMIPROFE2024"; const PREGUNTAS_POR_JUEGO = 10;
        let DOM = {};
        function mapDOM() { DOM = { screens: { splash: document.getElementById('splash-screen'), name: document.getElementById('name-screen'), setup: document.getElementById('setup-screen'), game: document.getElementById('game-screen'), end: document.getElementById('end-screen'), adminLogin: document.getElementById('admin-login-screen'), adminDashboard: document.getElementById('admin-dashboard-screen'), adminReport: document.getElementById('admin-report-screen'), challengeOffer: document.getElementById('challenge-offer-screen') }, splashTitle: document.getElementById('splash-title'), continueBtn: document.getElementById('continue-btn'), nameInput: document.getElementById('name-input'), submitNameBtn: document.getElementById('submit-name-btn'), setupTitle: document.getElementById('setup-title'), setupGradeButtons: document.getElementById('setup-grade-buttons'), questionText: document.getElementById('question-text'), answerButtons: document.getElementById('answer-buttons'), chartContainer: document.getElementById('chart-container'), questionChart: document.getElementById('question-chart'), nextBtn: document.getElementById('next-btn'), restartBtn: document.getElementById('restart-btn'), questionCounter: document.getElementById('question-counter'), errorsStatus: document.getElementById('errors-status'), endTitle: document.getElementById('end-title'), endMessage: document.getElementById('end-message'), finalGradeText: document.getElementById('final-grade-text'), xpEarnedText: document.getElementById('xp-earned-text'), leaderboardTable: document.getElementById('leaderboard-table'), feedbackBox: document.getElementById('feedback-box'), achievementsList: document.getElementById('achievements-list'), adminPassword: document.getElementById('admin-password'), adminLoginBtn: document.getElementById('admin-login-btn'), adminBackBtn: document.getElementById('admin-back-btn'), adminGradeSelection: document.getElementById('admin-grade-selection'), downloadAnalyticsBtn: document.getElementById('download-analytics-btn'), resetAllAnalyticsBtn: document.getElementById('reset-all-analytics-btn'), adminLogoutBtn: document.getElementById('admin-logout-btn'), adminReportTitle: document.getElementById('admin-report-title'), adminReportView: document.getElementById('admin-report-view'), backToDashboardBtn: document.getElementById('back-to-dashboard-btn'), acceptChallengeBtn: document.getElementById('accept-challenge-btn'), declineChallengeBtn: document.getElementById('decline-challenge-btn'), }; }
        let bancoDePreguntas = {}; let preguntasDelGrado = []; let preguntaActualIndex = 0; let errores = 0; let userName = "JUGADOR"; let currentGrade = 0; let adminClickCount = 0; let adminClickTimer = null; let maxErrores = 3; let aciertos = 0; let xp = 0; let enModoDesafio = false; let idsPreguntasUsadas = new Set(); let aciertosModoNormal = 0; let myChart = null;

        function showScreen(screenName) { Object.values(DOM.screens).forEach(screen => screen.classList.remove('active')); DOM.screens[screenName].classList.add('active'); }
        function getAnalytics() { return JSON.parse(localStorage.getItem('quimiAnalytics') || '{}'); }
        function trackIncorrectAnswer(questionId) { let analytics = getAnalytics(); analytics[questionId] = (analytics[questionId] || 0) + 1; localStorage.setItem('quimiAnalytics', JSON.stringify(analytics)); }
        
        function seleccionarRespuesta(e) {
            const botonSeleccionado = e.target; const esCorrecto = botonSeleccionado.dataset.correcto === "true";
            Array.from(DOM.answerButtons.children).forEach(button => { button.disabled = true; if (button.dataset.correcto) button.classList.add('correct'); });
            if (esCorrecto) { aciertos++; } else {
                errores++; botonSeleccionado.classList.add('incorrect'); const currentQuestion = preguntasDelGrado[preguntaActualIndex];
                if (currentQuestion.id) trackIncorrectAnswer(currentQuestion.id);
                if (currentQuestion.retroalimentacion && currentQuestion.retroalimentacion.trim() !== "") { DOM.feedbackBox.innerHTML = `<strong>Pista del Profesor:</strong> ${currentQuestion.retroalimentacion}`; DOM.feedbackBox.classList.remove('hidden'); }
            }
            actualizarEstadoVisual();
            const isLastQuestionNormalMode = !enModoDesafio && preguntaActualIndex === PREGUNTAS_POR_JUEGO - 1;
            if (errores >= maxErrores) { const estadoFinal = { perdio: true, aciertos: aciertos, errores: errores, enDesafio: enModoDesafio, aciertosModoNormal: enModoDesafio ? aciertosModoNormal : aciertos }; setTimeout(() => terminarJuego(estadoFinal), 2000);
            } else if (isLastQuestionNormalMode) { const estadoFinal = { perdio: false, aciertos: aciertos, errores: errores, enDesafio: false }; setTimeout(() => verificarModoDesafio(estadoFinal), 1500);
            } else { DOM.nextBtn.classList.remove('hidden'); }
        }
        function verificarModoDesafio(estadoFinal) { if (estadoFinal.errores === 0) { aciertosModoNormal = estadoFinal.aciertos; showScreen('challengeOffer'); } else { terminarJuego(estadoFinal); } }
        function iniciarModoDesafio() {
            enModoDesafio = true; maxErrores = 1; errores = 0;
            let todasLasPreguntas = []; bancoDePreguntas[currentGrade].forEach(tema => todasLasPreguntas.push(...tema.preguntas));
            preguntasDelGrado = todasLasPreguntas.filter(q => q.dificultad >= 3 && !idsPreguntasUsadas.has(q.id));
            if (preguntasDelGrado.length === 0) {
                alert("¬°Felicidades! Has agotado todas las preguntas de m√°xima dificultad.");
                const estadoFinal = { perdio: false, aciertos: aciertos, errores: 0, enDesafio: true, aciertosModoNormal: aciertosModoNormal };
                terminarJuego(estadoFinal); return;
            }
            preguntaActualIndex = 0; mostrarSiguientePregunta();
        }
        function terminarJuego(estadoFinal) {
            const aciertosBase = estadoFinal.enDesafio ? aciertosModoNormal : estadoFinal.aciertos;
            const notaFinal = 1 + 9 * (aciertosBase / PREGUNTAS_POR_JUEGO);
            let xpCalculado = estadoFinal.aciertos * 150 + (enModoDesafio ? (PREGUNTAS_POR_JUEGO + preguntaActualIndex + 1) : (preguntaActualIndex + 1)) * 50;
            const bonusErrores = [1000, 500, 200];
            if (!estadoFinal.enDesafio && !estadoFinal.perdio) { xpCalculado += bonusErrores[estadoFinal.errores] || 0; } 
            else if (estadoFinal.enDesafio && !estadoFinal.perdio) { xpCalculado += 2000; }
            DOM.endTitle.innerText = estadoFinal.perdio ? "FIN DE LA TRANSMISI√ìN" : "MISI√ìN CUMPLIDA";
            DOM.endMessage.innerText = estadoFinal.perdio ? `L√≠mite de errores alcanzado, ${userName}. ¬°Sigue intentando!` : `¬°Felicitaciones, ${userName}! Has completado el reto.`;
            DOM.finalGradeText.innerHTML = `> <strong>NOTA DE PARTIDA: ${notaFinal.toFixed(1)} / 10.0</strong>`;
            DOM.xpEarnedText.innerHTML = `> <strong>XP GANADO: ${xpCalculado}</strong>`;
            const erroresParaLogros = estadoFinal.enDesafio ? 0 : estadoFinal.errores;
            const achievements = checkAchievements(notaFinal, erroresParaLogros, estadoFinal.enDesafio, !estadoFinal.perdio);
            displayAchievements(achievements);
            saveToLeaderboard(currentGrade, userName, xpCalculado);
            displayLeaderboard(currentGrade);
            showScreen('end');
        }
        function init() {
            mapDOM();
            DOM.splashTitle.addEventListener('click', () => { clearTimeout(adminClickTimer); adminClickCount++; if (adminClickCount === 5) { showScreen('adminLogin'); adminClickCount = 0; } adminClickTimer = setTimeout(() => { adminClickCount = 0; }, 1000); });
            DOM.adminLoginBtn.addEventListener('click', () => { if (DOM.adminPassword.value === ADMIN_PASSWORD) { DOM.adminGradeSelection.innerHTML = ''; Object.keys(bancoDePreguntas).sort((a,b) => parseInt(a) - parseInt(b)).forEach(grade => { const btn = document.createElement('button'); btn.className = 'btn'; btn.innerText = `GRADO ${grade}¬∞`; btn.onclick = () => { DOM.adminReportTitle.innerText = `> INFORME - GRADO ${grade}¬∞`; generarInforme(grade); showScreen('adminReport'); }; DOM.adminGradeSelection.appendChild(btn); }); showScreen('adminDashboard'); DOM.adminPassword.value = ''; } else { alert("Contrase√±a incorrecta."); } });
            DOM.adminBackBtn.addEventListener('click', () => { location.reload(); });
            DOM.adminLogoutBtn.addEventListener('click', () => { location.reload(); });
            DOM.backToDashboardBtn.addEventListener('click', () => showScreen('adminDashboard'));
            DOM.downloadAnalyticsBtn.addEventListener('click', () => { const data = JSON.stringify(getAnalytics(), null, 2); if (data === '{}') { alert("No hay datos."); return; } const blob = new Blob([data], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'analiticas_quimica.json'; a.click(); URL.revokeObjectURL(url); });
            DOM.resetAllAnalyticsBtn.addEventListener('click', () => { if (confirm("¬øBorrar TODOS los datos de anal√≠ticas?")) { localStorage.removeItem('quimiAnalytics'); alert("Datos borrados."); } });
            DOM.continueBtn.addEventListener('click', () => showScreen('name'));
            DOM.submitNameBtn.addEventListener('click', () => { const name = DOM.nameInput.value.trim().toUpperCase(); if (name) userName = name; DOM.setupTitle.innerText = `> BIENVENIDO, ${userName}`; showScreen('setup'); });
            DOM.nextBtn.addEventListener('click', () => { preguntaActualIndex++; mostrarSiguientePregunta(); });
            DOM.restartBtn.addEventListener('click', () => { showScreen('setup'); });
            DOM.acceptChallengeBtn.addEventListener('click', () => { showScreen('game'); iniciarModoDesafio(); });
            DOM.declineChallengeBtn.addEventListener('click', () => { const estadoFinal = { perdio: false, aciertos: aciertosModoNormal, errores: 0, enDesafio: false, aciertosModoNormal: aciertosModoNormal }; terminarJuego(estadoFinal); });
            main();
        }
        async function main() {
            const lines = ['splash-title', 'line-1', 'line-2', 'line-3', 'line-4', 'line-5', 'line-6', 'line-7', 'line-8', 'line-9', 'loading-text'];
            for (const lineId of lines) { const element = document.getElementById(lineId); if(element) { await new Promise(resolve => setTimeout(resolve, lineId === 'splash-title' ? 500 : 200)); element.style.visibility = 'visible'; } }
            try {
                const response = await fetch('preguntas.json'); if (!response.ok) throw new Error(`HTTP error, status = ${response.status}`);
                bancoDePreguntas = await response.json();
                DOM.setupGradeButtons.innerHTML = ''; const grados = Object.keys(bancoDePreguntas).sort((a, b) => parseInt(a) - parseInt(b));
                grados.forEach(grade => { const btn = document.createElement('button'); btn.className = 'btn grade-btn'; btn.dataset.grade = grade; btn.innerText = `GRADO ${grade}¬∞`; btn.addEventListener('click', () => { currentGrade = grade; seleccionarGradoYEmpezar(currentGrade); }); DOM.setupGradeButtons.appendChild(btn); });
                const loadingText = document.getElementById('loading-text'); loadingText.innerText = '> CARGA COMPLETA.'; loadingText.classList.remove('blinking-cursor'); DOM.continueBtn.classList.remove('hidden');
            } catch (error) { console.error("Error al cargar preguntas.json:", error); const loadingText = document.getElementById('loading-text'); loadingText.innerText = '> ERROR DE CARGA. VERIFIQUE `preguntas.json`.'; loadingText.style.color = 'var(--red-error)'; }
        }
        
        // --- FUNCI√ìN DE SELECCI√ìN DE PREGUNTAS (NUEVA L√ìGICA ROBUSTA) ---
        function seleccionarGradoYEmpezar(grado) {
            let todasLasPreguntas = [];
            if (bancoDePreguntas[grado]) { bancoDePreguntas[grado].forEach(tema => todasLasPreguntas.push(...tema.preguntas)); }
            if (todasLasPreguntas.length < PREGUNTAS_POR_JUEGO) { alert(`No hay suficientes preguntas para grado ${grado}¬∞ (${todasLasPreguntas.length}/${PREGUNTAS_POR_JUEGO}). Profe, ¬°a completar el JSON!`); return; }
            const shuffle = (arr) => arr.sort(() => 0.5 - Math.random());
            const preguntasBarajadas = shuffle(todasLasPreguntas);
            preguntasDelGrado = preguntasBarajadas.slice(0, PREGUNTAS_POR_JUEGO);
            preguntasDelGrado.sort((a, b) => a.dificultad - b.dificultad);
            idsPreguntasUsadas.clear(); preguntasDelGrado.forEach(q => idsPreguntasUsadas.add(q.id));
            iniciarJuego();
        }

        // --- FUNCIONES DEL PANEL DE ADMIN CON GR√ÅFICOS ---
        let adminCharts = []; // Para destruir los gr√°ficos al cambiar de vista
        function generarInforme(grado) {
            adminCharts.forEach(chart => chart.destroy()); // Limpiar gr√°ficos anteriores
            adminCharts = [];
            
            const analytics = getAnalytics();
            const allQuestions = [];
            if(bancoDePreguntas[grado]) bancoDePreguntas[grado].forEach(tema => allQuestions.push(...tema.preguntas));
            const questionMap = allQuestions.reduce((acc, q) => { if(q.id) acc[q.id] = q; return acc; }, {});
            const errorList = Object.entries(analytics).filter(([id]) => questionMap[id]).map(([id, count]) => ({ id, count, question: questionMap[id].pregunta, tema: questionMap[id].tema, competencia: questionMap[id].competencia })).sort((a, b) => b.count - a.count);
            
            DOM.adminReportView.innerHTML = ''; // Limpiar vista
            if (errorList.length === 0) { DOM.adminReportView.innerHTML = "<p>No hay datos de errores para este grado.</p>"; return; }

            // Gr√°fico de Competencias
            const competencias = errorList.reduce((acc, err) => { acc[err.competencia] = (acc[err.competencia] || 0) + err.count; return acc; }, {});
            let reportHTML = `<div class="admin-section"><h3>Rendimiento por Competencia</h3><div class="admin-chart-container"><canvas id="competencyChart"></canvas></div></div>`;
            
            // Gr√°fico de Temas
            const temas = errorList.reduce((acc, err) => { acc[err.tema] = (acc[err.tema] || 0) + err.count; return acc; }, {});
            const sortedTemas = Object.entries(temas).sort((a, b) => b[1] - a[1]);
            reportHTML += `<div class="admin-section"><h3>Temas a Reforzar</h3><div class="admin-chart-container"><canvas id="topicChart"></canvas></div></div>`;

            // Lista de Preguntas
            const topQuestions = errorList.slice(0, 5);
            reportHTML += `<div class="admin-section"><h3>Preguntas "Punto Ciego"</h3>`;
            topQuestions.forEach((q, i) => { reportHTML += `<p>${i+1}. (${q.count} errores) - ${q.question}</p>`; });
            reportHTML += `</div>`;
            DOM.adminReportView.innerHTML = reportHTML;

            // Renderizar gr√°ficos
            const retroFont = { family: "'Press Start 2P', cursive", size: 8 };
            const retroColor = 'var(--retro-green)';
            
            adminCharts.push(new Chart(document.getElementById('competencyChart'), {
                type: 'doughnut',
                data: { labels: Object.keys(competencias), datasets: [{ label: 'Errores', data: Object.values(competencias), backgroundColor: ['#00FF41', '#f39c12', '#e74c3c', '#3498db', '#9b59b6'] }] },
                options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: retroColor, font: retroFont } } } }
            }));
            
            adminCharts.push(new Chart(document.getElementById('topicChart'), {
                type: 'bar',
                data: { labels: sortedTemas.map(t => t[0]), datasets: [{ label: 'N¬∫ de Errores', data: sortedTemas.map(t => t[1]), backgroundColor: 'rgba(0, 255, 65, 0.5)', borderColor: retroColor, borderWidth: 1 }] },
                options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: retroColor, font: retroFont } }, x: { ticks: { color: retroColor, font: retroFont } } } }
            }));
        }

        // --- Funciones auxiliares restantes ---
        function checkAchievements(notaFinal, erroresNormal, enDesafio, gano) { const achievements = []; if (erroresNormal === 0 && !enDesafio) achievements.push({ icon: 'üèÖ', text: 'Misi√≥n Perfecta' }); if (erroresNormal === 1) achievements.push({ icon: 'üéØ', text: 'Precisi√≥n Quir√∫rgica' }); if (notaFinal >= 9.0) achievements.push({ icon: 'üèÜ', text: 'Rango Maestro' }); if (enDesafio && gano) achievements.push({ icon: 'üî•', text: 'Leyenda de la Consola' }); return achievements; }
        function displayAchievements(achievements) { const section = document.getElementById('achievements-section'); if (achievements.length === 0) { section.classList.add('hidden'); } else { section.classList.remove('hidden'); DOM.achievementsList.innerHTML = achievements.map(ach => `<span class="achievement"><span class="icon">${ach.icon}</span> ${ach.text}</span>`).join(''); } }
        function actualizarEstadoVisual() { DOM.questionCounter.innerText = enModoDesafio ? `DESAF√çO: ${preguntaActualIndex + 1}` : `PREGUNTA: ${preguntaActualIndex + 1}/${PREGUNTAS_POR_JUEGO}`; DOM.errorsStatus.innerText = `ERRORES: ${errores}/${maxErrores}`; }
        function resetearEstadoVisual() { if(myChart) { myChart.destroy(); myChart = null; } DOM.chartContainer.classList.add('hidden'); DOM.nextBtn.classList.add('hidden'); DOM.feedbackBox.classList.add('hidden'); while (DOM.answerButtons.firstChild) DOM.answerButtons.removeChild(DOM.answerButtons.firstChild); }
        function iniciarJuego() { errores = 0; aciertos = 0; xp = 0; preguntaActualIndex = 0; maxErrores = 3; enModoDesafio = false; aciertosModoNormal = 0; showScreen('game'); DOM.nextBtn.classList.add('hidden'); mostrarSiguientePregunta(); }
        function mostrarSiguientePregunta() { resetearEstadoVisual(); if (preguntaActualIndex < preguntasDelGrado.length) { mostrarPregunta(preguntasDelGrado[preguntaActualIndex]); } else { const estadoFinal = { perdio: false, aciertos: aciertos, errores: errores, enDesafio: enModoDesafio, aciertosModoNormal: aciertosModoNormal }; terminarJuego(estadoFinal); } }
        function mostrarPregunta(pregunta) {
            DOM.questionText.innerText = pregunta.pregunta;
            if (pregunta.grafico) {
                DOM.chartContainer.classList.remove('hidden');
                const retroOptions = { plugins: { legend: { labels: { color: 'var(--retro-green)', font: { family: "'Press Start 2P', cursive" } } } }, scales: { y: { grid: { color: 'rgba(0, 255, 65, 0.2)' }, ticks: { color: 'var(--retro-green)', font: { family: "'Press Start 2P', cursive", size: 10 } }, title: { display: pregunta.grafico.opciones?.scales?.y?.title?.display, text: pregunta.grafico.opciones?.scales?.y?.title?.text, color: 'var(--retro-green)', font: { family: "'Press Start 2P', cursive" } } }, x: { grid: { color: 'rgba(0, 255, 65, 0.2)' }, ticks: { color: 'var(--retro-green)', font: { family: "'Press Start 2P', cursive", size: 10 } }, title: { display: pregunta.grafico.opciones?.scales?.x?.title?.display, text: pregunta.grafico.opciones?.scales?.x?.title?.text, color: 'var(--retro-green)', font: { family: "'Press Start 2P', cursive" } } } } };
                const chartConfig = { type: pregunta.grafico.tipo, data: pregunta.grafico.datos, options: { ...pregunta.grafico.opciones, ...retroOptions } };
                myChart = new Chart(DOM.questionChart, chartConfig);
            }
            pregunta.opciones.forEach(opcion => { const button = document.createElement('button'); button.innerText = opcion.texto; button.classList.add('btn'); if (opcion.correcto) button.dataset.correcto = true; button.addEventListener('click', seleccionarRespuesta); DOM.answerButtons.appendChild(button); });
            actualizarEstadoVisual();
        }
        function getLeaderboard(grade) { const leaderboardJSON = localStorage.getItem(`leaderboard_grade_${grade}`); return leaderboardJSON ? JSON.parse(leaderboardJSON) : []; }
        function saveToLeaderboard(grade, name, score) { let leaderboard = getLeaderboard(grade); leaderboard.push({ name, score }); leaderboard.sort((a, b) => b.score - a.score); leaderboard = leaderboard.slice(0, 5); localStorage.setItem(`leaderboard_grade_${grade}`, JSON.stringify(leaderboard)); }
        function displayLeaderboard(grade) { const leaderboard = DOM.leaderboardTable; const scores = getLeaderboard(grade); leaderboard.innerHTML = ''; if (scores.length === 0) { leaderboard.innerHTML = `<tr><td>A√∫n no hay puntajes. ¬°S√© el primero!</td></tr>`; } else { scores.forEach((entry, index) => { const row = `<tr><td>${index + 1}. ${entry.name}</td><td>${entry.score} XP</td></tr>`; leaderboard.innerHTML += row; }); } }
        
        init();
    });
    </script>
</body>
</html>